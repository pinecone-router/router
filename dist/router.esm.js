var k=class{params={};path;handlers=[];constructor(t,d={}){this.path=t,Object.keys(d).forEach(u=>{this[u]=d[u]}),d.templates&&(this.programmaticTemplates=!0)}templates=[];templateTargetId="";programmaticTemplates=!1;handlersDone=!1;cancelHandlers},H=k;function S(l){return l.replace(/(^\/+|\/+$)/g,"").split("/")}function C(l,t){let d=/(?:\?([^#]*))?(#.*)?$/,u=l.match(d),p={},_;if(u&&u[1]){let c=u[1].split("&");for(let f=0;f<c.length;f++){let x=c[f].split("=");p[decodeURIComponent(x[0])]=decodeURIComponent(x.slice(1).join("="))}}let P=S(l.replace(d,"")),w=S(t||""),R=Math.max(P.length,w.length);for(let c=0;c<R;c++)if(w[c]&&w[c].charAt(0)===":"){let f=w[c].replace(/(^:|[+*?]+$)/g,""),x=(w[c].match(/[+*?]+$/)||{}).toString()[0],v=~x.indexOf("+"),y=~x.indexOf("*"),h=P[c]||"";if(!h&&!y&&(x.indexOf("?")<0||v)){_=!1;break}if(p[f]=decodeURIComponent(h),v||y){p[f]=P.slice(c).map(decodeURIComponent).join("/");break}}else if(w[c]!==P[c]){_=!1;break}return _===!1?!1:p}function T(l,...t){if(window.PineconeRouterMiddlewares)for(let d in window.PineconeRouterMiddlewares){let u=window.PineconeRouterMiddlewares[d];if(u[l]==null)return;if(u[l](...t)=="stop")return"stop"}}function W(l){document.dispatchEvent(new CustomEvent("fetch-error",{detail:l}))}function D(l){let t=l.reactive({version:"5.1.0",name:"pinecone-router",settings:{hash:!1,basePath:"/",templateTargetId:null,interceptLinks:!0},notfound:new H("notfound"),routes:[],context:{route:"",path:"",params:{},query:window.location.search.substring(1),hash:window.location.hash.substring(1),navigationStack:[],navigationIndex:0,redirect(e){return h(e),"stop"},navigate(e){h(e)},canGoBack(){return this.navigationIndex>0},back(){h(this.navigationStack[this.navigationIndex-1],!1,!1,this.navigationIndex-1)},canGoForward(){return this.navigationIndex<this.navigationStack.length-1},forward(){h(this.navigationStack[this.navigationIndex+1],!1,!1,this.navigationIndex+1)}},add(e,n){if(this.routes.find(r=>r.path==e)!=null)throw new Error("Pinecone Router: route already exist");return this.routes.push(new H(e,n))-1},remove(e){this.routes=this.routes.filter(n=>n.path!=e)},loadStart:new Event("pinecone-start"),loadEnd:new Event("pinecone-end")});window.PineconeRouter=t;var d={},u={};let p=new Set,_=(e,n,r)=>{if(p.has(n))return;p.add(n);let i=e.content.cloneNode(!0).firstElementChild;i&&(l.addScopeToNode(i,{},e),l.mutateDom(()=>{r!=null?r.appendChild(i):e.after(i),l.initTree(i)}),e._x_PineconeRouter_CurrentTemplate=i,e._x_PineconeRouter_undoTemplate=()=>{i.remove(),delete e._x_PineconeRouter_CurrentTemplate},l.nextTick(()=>p.delete(n)))};function P(e){e._x_PineconeRouter_undoTemplate&&(e._x_PineconeRouter_undoTemplate(),delete e._x_PineconeRouter_undoTemplate)}function w(e,n,r,i){if(e._x_PineconeRouter_CurrentTemplate)return e._x_PineconeRouter_CurrentTemplate;e.content.firstElementChild?(_(e,n,i),f()):r&&(r.every(o=>u[o])?(r.length>1&&(e.innerHTML="<templates-wrapper>"),r.forEach(o=>{e.innerHTML+=u[o]}),r.length>1&&(e.innerHTML="</templates-wrapper>"),_(e,n,i),f()):R(e,r).then(()=>_(e,n,i)).finally(()=>f()))}let R=(e,n,r=!1,i=!1)=>{let o=n.map(a=>d[a]?d[a]:u[a]?new Promise(s=>{s(u[a])}):(d[a]=fetch(a).then(s=>s.ok?s.text():(W(s.statusText),null)).then(s=>s==null?(u[a]=null,d[a]=null,null):(u[a]=s,d[a]=null,s)),d[a]));return Promise.all(o).then(a=>{let s=a.filter(m=>m!==null).join("");return n.length>1&&!r?e.innerHTML="<templates-wrapper>"+s+"</templates-wrapper>":e.innerHTML=s,e.innerHTML})},c=()=>{document.dispatchEvent(t.loadStart)},f=()=>{document.dispatchEvent(t.loadEnd)},x=e=>!t.settings.hash&&t.settings.basePath!="/"?t.settings.basePath+e:e,v=e=>t.routes.findIndex(n=>n.path==e);l.directive("route",(e,{expression:n,modifiers:r},{effect:i,cleanup:o})=>{let a=n;if(T("onBeforeRouteProcessed",e,a),a.indexOf("#")>-1)throw new Error("Pinecone Router: A route's path may not have a hash character.");let s=M(r,"target",null)??window.PineconeRouter.settings.templateTargetId,m=document.getElementById(s);if(s&&!m)throw new Error("Pinecone Router: Can't find an element with the suplied target ID: "+s);let g=null;a!="notfound"&&(a=x(a),g=t.add(a));let E=t.routes[g]??t.notfound;e._x_PineconeRouter_route=a,e.content.firstElementChild!=null&&l.nextTick(()=>{i(()=>{E.handlersDone&&t.context.route==a?w(e,n,null,m):P(e)})}),o(()=>{e._x_PineconeRouter_undoTemplate&&e._x_PineconeRouter_undoTemplate(),t.remove(a),delete e._x_PineconeRouter_route}),T("onAfterRouteProcessed",e,a)}),l.directive("handler",(e,{expression:n},{evaluate:r,cleanup:i})=>{if(!e._x_PineconeRouter_route)throw new Error("Pinecone Router: x-handler must be set on the same element as x-route.");let o;!(n.startsWith("[")&&n.endsWith("]"))&&!(n.startsWith("Array(")&&n.endsWith(")"))&&(n=`[${n}]`);let a=r(n);if(typeof a=="object")o=a;else throw new Error(`Pinecone Router: Invalid handler type: ${typeof a}.`);for(let g=0;g<o.length;g++)o[g]=o[g].bind(l.$data(e));let s=e._x_PineconeRouter_route,m=s=="notfound"?t.notfound:t.routes[v(s)];m.handlers=o,i(()=>{m.handlers=[],m.handlersDone=!0,m.cancelHandlers=!1})}),l.directive("template",(e,{modifiers:n,expression:r},{Alpine:i,effect:o,evaluate:a,cleanup:s})=>{if(!e._x_PineconeRouter_route)throw new Error("Pinecone Router: x-template must be used on the same element as x-route.");if(e.content.firstElementChild!=null)throw new Error("Pinecone Router: x-template cannot be used alongside an inline template (template element should not have a child).");!(r.startsWith("[")&&r.endsWith("]"))&&!(r.startsWith("Array(")&&r.endsWith(")"))&&(r=`['${r}']`);let m=a(r),g;if(typeof m=="object")g=m;else throw new Error(`Pinecone Router: Invalid handler type: ${typeof m}.`);let E=M(n,"target",null)??window.PineconeRouter.settings.templateTargetId,b=document.getElementById(E);if(E&&!b)throw new Error("Pinecone Router: Can't find an element with the suplied target ID: "+E);n.includes("preload")&&R(e,g,!1,!0);let L=e._x_PineconeRouter_route,I=L=="notfound"?t.notfound:t.routes[v(L)];I.templates=g,i.nextTick(()=>{o(()=>{I.handlersDone&&t.context.route==I.path?w(e,r,g,b):P(e)})}),s(()=>{e._x_PineconeRouter_undoTemplate&&e._x_PineconeRouter_undoTemplate()})}),l.$router=t.context,l.magic("router",()=>t.context),document.addEventListener("alpine:initialized",()=>{T("init"),t.settings.hash==!1?h(location.pathname,!1,!0):h(location.hash.substring(1),!1,!0)}),window.addEventListener("popstate",()=>{t.settings.hash?window.location.hash!=""&&h(window.location.hash.substring(1),!0):h(window.location.pathname,!0)}),y();function y(){function e(n){if(!n||!n.getAttribute)return;let r=n.getAttribute("href"),i=n.getAttribute("target");if(!(!r||!r.match(/^\//g)||i&&!i.match(/^_?self$/i)))return typeof r!="string"&&r.url&&(r=r.url),r}window.document.body.addEventListener("click",function(n){if(n.ctrlKey||n.metaKey||n.altKey||n.shiftKey||n.button||n.defaultPrevented)return;let r=t.routes[v(t.context.route)]??t.notfound;r.handlersDone||(r.cancelHandlers=!0,f());let i=n.target;do if(i.localName==="a"&&i.getAttribute("href")){if(window.PineconeRouter.settings.interceptLinks==!1&&!i.hasAttribute("x-link")||i.hasAttribute("data-native")||i.hasAttribute("native"))return;let o=e(i);o&&(h(o),n.stopImmediatePropagation&&n.stopImmediatePropagation(),n.stopPropagation&&n.stopPropagation(),n.preventDefault());break}while(i=i.parentNode)})}async function h(e,n=!1,r=!1,i=null){e||(e="/"),t.settings.hash||(t.settings.basePath!="/"&&!e.startsWith(t.settings.basePath)&&(e=t.settings.basePath+e),e==t.settings.basePath&&!e.endsWith("/")&&(e+="/")),i!=null?t.context.navigationIndex=i:e!=t.context.path&&(t.context.navigationIndex!==t.context.navigationStack.length-1?(t.context.navigationStack=t.context.navigationStack.slice(0,t.context.navigationIndex+1),t.context.navigationStack.push(e),t.context.navigationIndex=t.context.navigationStack.length-1):(t.context.navigationStack.push(e),t.context.navigationIndex=t.context.navigationStack.length-1));let o=t.routes.find(a=>{let s=C(e,a.path);return a.params=s!=!1?s:{},s!=!1})??t.notfound;if(o.handlersDone=!o.handlers.length,(o.handlers.length||o.templates.length)&&c(),$(o.path,e,o.params),T("onBeforeHandlersExecuted",o,e,r)=="stop"){f();return}if(!n){let a="";if(t.settings.hash?(a="#",a+=window.location.search+e):a=e+window.location.search+window.location.hash,!r)history.pushState({path:a},"",a);else if(t.settings.hash&&e=="/")return h("/",!1,!1)}if(o&&o.handlers.length){if(o.cancelHandlers=!1,!await B(o.handlers,t.context)){f();return}o.handlersDone=!0,o.templates||f()}if(o.templates.length&&o.programmaticTemplates){let a=o.templateTargetId?document.getElementById(o.templateTargetId):document.getElementById(t.settings.templateTargetId);R(a,o.templates,o.programmaticTemplates).then(()=>{f()})}T("onHandlersExecuted",o,e,r)}function $(e,n,r){t.context.route=e,t.context.path=n,t.context.params=r,t.context.query=window.location.search.substring(1),t.context.hash=window.location.hash.substring(1)}function M(e,n,r){if(e.indexOf(n)===-1)return r;let i=e[e.indexOf(n)+1];if(!i)return r;if(n==="target"){let o=i.match(/([a-z0-9_-]+)/);if(o)return o[1]}return i}async function B(e,n){for(let r=0;r<e.length;r++)if(typeof e[r]=="function"){let i=t.routes[v(n.route)]??t.notfound;if(i.cancelHandlers)return i.cancelHandlers=!1,!1;let o;if(e[r].constructor.name==="AsyncFunction"?o=await e[r](n):o=e[r](n),o=="stop")return!1}return!0}}var F=D;export{F as default};
//# sourceMappingURL=router.esm.js.map
