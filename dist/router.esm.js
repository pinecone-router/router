var C=class{constructor(o,f={}){this.params={};this.handlers=[];this.handlersDone=!1;this.path=o,Object.keys(f).forEach(c=>{this[c]=f[c]})}},M=C;function k(a){return a.replace(/(^\/+|\/+$)/g,"").split("/")}function I(a,o){let f=/(?:\?([^#]*))?(#.*)?$/,c=a.match(f),w={},_;if(c&&c[1]){let u=c[1].split("&");for(let P=0;P<u.length;P++){let d=u[P].split("=");w[decodeURIComponent(d[0])]=decodeURIComponent(d.slice(1).join("="))}}let x=k(a.replace(f,"")),h=k(o||""),E=Math.max(x.length,h.length);for(let u=0;u<E;u++)if(h[u]&&h[u].charAt(0)===":"){let P=h[u].replace(/(^:|[+*?]+$)/g,""),d=(h[u].match(/[+*?]+$/)||{}).toString()[0],v=~d.indexOf("+"),R=~d.indexOf("*"),b=x[u]||"";if(!b&&!R&&(d.indexOf("?")<0||v)){_=!1;break}if(w[P]=decodeURIComponent(b),v||R){w[P]=x.slice(u).map(decodeURIComponent).join("/");break}}else if(h[u]!==x[u]){_=!1;break}return _===!1?!1:w}function T(a,...o){if(!!window.PineconeRouterMiddlewares)for(let f in window.PineconeRouterMiddlewares){let c=window.PineconeRouterMiddlewares[f];if(c[a]==null)return;if(c[a](...o)=="stop")return"stop"}}function D(a){document.dispatchEvent(new CustomEvent("fetch-error",{detail:a}))}function S(a){let o=a.reactive({version:"4.2.0",name:"pinecone-router",settings:{hash:!1,basePath:"/",templateTargetId:null},notfound:new M("notfound"),routes:[],context:{route:"",path:"",params:{},query:window.location.search.substring(1),hash:window.location.hash.substring(1),redirect(e){return g(e),"stop"},navigate(e){g(e)}},add(e,t){if(this.routes.find(n=>n.path==e)!=null)throw new Error("Pinecone Router: route already exist");return this.routes.push(new M(e,t))-1},remove(e){this.routes=this.routes.filter(t=>t.path!=e)},loadStart:new Event("pinecone-start"),loadEnd:new Event("pinecone-end")});window.PineconeRouter=o;var f={},c={};let w=new Set;var _={};let x=(e,t)=>(f[t]?f[t].then(n=>e.innerHTML=n):f[t]=fetch(t).then(n=>n.ok?n.text():(D(n.statusText),null)).then(n=>n==null?(c[t]=null,f[t]=null,null):(c[t]=n,e.innerHTML=n,n)),f[t]),h=(e,t,n)=>{if(w.has(t))return;w.add(t);let r=e.content.cloneNode(!0).firstElementChild;!r||(a.addScopeToNode(r,{},e),a.mutateDom(()=>{n!=null?n.appendChild(r):e.after(r),a.initTree(r)}),e._x_PineconeRouter_CurrentTemplate=r,e._x_PineconeRouter_undoTemplate=()=>{r.remove(),delete e._x_PineconeRouter_CurrentTemplate},a.nextTick(()=>w.delete(t)))};function E(e){e._x_PineconeRouter_undoTemplate&&(e._x_PineconeRouter_undoTemplate(),delete e._x_PineconeRouter_undoTemplate)}function u(e,t,n,r){if(e._x_PineconeRouter_CurrentTemplate)return e._x_PineconeRouter_CurrentTemplate;e.content.firstElementChild?(h(e,t,r),d()):n&&(c[n]?(e.innerHTML=c[n],h(e,t,r),d()):_[n]?_[n].then(()=>h(e,t,r)):x(e,n).then(()=>h(e,t,r)).finally(()=>d()))}let P=()=>{document.dispatchEvent(o.loadStart)},d=()=>{document.dispatchEvent(o.loadEnd)},v=e=>!o.settings.hash&&o.settings.basePath!="/"?o.settings.basePath+e:e,R=e=>o.routes.findIndex(t=>t.path==e);a.directive("route",(e,{expression:t,modifiers:n},{effect:r,cleanup:s})=>{let i=t;if(T("onBeforeRouteProcessed",e,i),i.indexOf("#")>-1)throw new Error("Pinecone Router: A route's path may not have a hash character.");let l=L(n,"target",null)??window.PineconeRouter.settings.templateTargetId,m=document.getElementById(l);if(l&&!m)throw new Error("Pinecone Router: Can't find an element with the suplied target ID: "+l);let p=null;i!="notfound"&&(i=v(i),p=o.add(i));let y=o.routes[p]??o.notfound;e._x_PineconeRouter_route=i,e.content.firstElementChild!=null&&a.nextTick(()=>{r(()=>{y.handlersDone&&o.context.route==i?u(e,t,null,m):E(e)})}),s(()=>{e._x_PineconeRouter_undoTemplate&&e._x_PineconeRouter_undoTemplate(),o.remove(i),delete e._x_PineconeRouter_route}),T("onAfterRouteProcessed",e,i)}),a.directive("handler",(e,{expression:t},{evaluate:n,cleanup:r})=>{if(!e._x_PineconeRouter_route)throw new Error("Pinecone Router: x-handler must be set on the same element as x-route.");let s;!(t.startsWith("[")&&t.endsWith("]"))&&!(t.startsWith("Array(")&&t.endsWith(")"))&&(t=`[${t}]`);let i=n(t);if(typeof i=="object")s=i;else throw new Error(`Pinecone Router: Invalid handler type: ${typeof i}.`);for(let p=0;p<s.length;p++)s[p]=s[p].bind(a.$data(e));let l=e._x_PineconeRouter_route,m=l=="notfound"?o.notfound:o.routes[R(l)];m.handlers=s,r(()=>{m.handlers=[],m.handlersDone=!0,m.cancelHandlers=!1})}),a.directive("template",(e,{modifiers:t,expression:n},{Alpine:r,effect:s,cleanup:i})=>{if(!e._x_PineconeRouter_route)throw new Error("Pinecone Router: x-template must be used on the same element as x-route.");if(e.content.firstElementChild!=null)throw new Error("Pinecone Router: x-template cannot be used alongside an inline template (template element should not have a child).");let l=n,m=L(t,"target",null)??window.PineconeRouter.settings.templateTargetId,p=document.getElementById(m);if(m&&!p)throw new Error("Pinecone Router: Can't find an element with the suplied target ID: "+m);t.includes("preload")&&(_[l]=x(e,l).finally(()=>{_[l]=null,d()}));let y=e._x_PineconeRouter_route,H=y=="notfound"?o.notfound:o.routes[R(y)];H.template=l,r.nextTick(()=>{s(()=>{H.handlersDone&&o.context.route==H.path?u(e,n,l,p):E(e)})}),i(()=>{e._x_PineconeRouter_undoTemplate&&e._x_PineconeRouter_undoTemplate()})}),a.$router=o.context,a.magic("router",()=>o.context),document.addEventListener("alpine:initialized",()=>{T("init"),o.settings.hash==!1?g(location.pathname,!1,!0):g(location.hash.substring(1),!1,!0)}),window.addEventListener("popstate",()=>{o.settings.hash?window.location.hash!=""&&g(window.location.hash.substring(1),!0):g(window.location.pathname,!0)}),b();function b(){function e(t){if(!t||!t.getAttribute)return;let n=t.getAttribute("href"),r=t.getAttribute("target");if(!(!n||!n.match(/^\//g)||r&&!r.match(/^_?self$/i)))return typeof n!="string"&&n.url&&(n=n.url),n}window.document.body.addEventListener("click",function(t){if(t.ctrlKey||t.metaKey||t.altKey||t.shiftKey||t.button||t.defaultPrevented)return;let n=o.routes[R(o.context.route)]??o.notfound;n.handlersDone||(n.cancelHandlers=!0,d());let r=t.target;do if(r.localName==="a"&&r.getAttribute("href")){if(r.hasAttribute("data-native")||r.hasAttribute("native"))return;let s=e(r);s&&(g(s),t.stopImmediatePropagation&&t.stopImmediatePropagation(),t.stopPropagation&&t.stopPropagation(),t.preventDefault());break}while(r=r.parentNode)})}async function g(e,t=!1,n=!1){e||(e="/"),o.context.path=e,o.settings.hash||(o.settings.basePath!="/"&&!e.startsWith(o.settings.basePath)&&(e=o.settings.basePath+e),e==o.settings.basePath&&!e.endsWith("/")&&(e+="/"));let r=o.routes.find(i=>{let l=I(e,i.path);return i.params=l!=!1?l:{},l!=!1})??o.notfound;r.handlersDone=!r.handlers.length,(r.handlers.length||r.template)&&P();let s=$(r.path,e,r.params);if(o.context=s,T("onBeforeHandlersExecuted",r,e,n)=="stop"){d();return}if(!t){let i="";if(o.settings.hash?(i="#",i+=window.location.search+e):i=e+window.location.search+window.location.hash,!n)history.pushState({path:i},"",i);else if(o.settings.hash&&e=="/")return o.context=s,g("/",!1,!1)}if(r&&r.handlers.length){if(r.cancelHandlers=!1,!await W(r.handlers,s)){d();return}r.handlersDone=!0,r.template||d()}T("onHandlersExecuted",r,e,n)}function $(e,t,n){return{route:e,path:t,params:n,query:window.location.search.substring(1),hash:window.location.hash.substring(1),redirect(r){return g(r),"stop"},navigate(r){g(r)}}}function L(e,t,n){if(e.indexOf(t)===-1)return n;let r=e[e.indexOf(t)+1];if(!r)return n;if(t==="target"){let s=r.match(/([a-z0-9_-]+)/);if(s)return s[1]}return r}async function W(e,t){for(let n=0;n<e.length;n++)if(typeof e[n]=="function"){let r=o.routes[R(t.route)]??o.notfound;if(r.cancelHandlers)return r.cancelHandlers=!1,!1;let s;if(e[n].constructor.name==="AsyncFunction"?s=await e[n](t):s=e[n](t),s=="stop")return!1}return!0}}var q=S;export{q as default};
//# sourceMappingURL=router.esm.js.map
